import { createClient } from '@supabase/supabase-js';
import fs from 'fs';

const supabaseUrl = process.env.PUBLIC_SUPABASE_URL;
const supabaseKey = process.env.PUBLIC_SUPABASE_ANON_KEY;

if (!supabaseUrl || !supabaseKey) {
    console.error('Missing SUPABASE env vars.');
    process.exit(1);
}

const supabase = createClient(supabaseUrl, supabaseKey);

async function upload() {
    console.log('ðŸ“‚ Loading fullAMCData.geojson...');
    const geojson = JSON.parse(fs.readFileSync('./static/data/fullAMCData.geojson', 'utf8'));
    console.log(`   Total features: ${geojson.features.length}`);

    const BATCH_SIZE = 100;
    let uploaded = 0;

    for (let i = 0; i < geojson.features.length; i += BATCH_SIZE) {
        const batch = geojson.features.slice(i, i + BATCH_SIZE).map(f => {
            const p = f.properties;
            return {
                objectid: p.OBJECTID,
                cut: p.CUT,
                cod_region: p.COD_REGION,
                region: p.REGION,
                cod_provincia: p.COD_PROVINCIA,
                provincia: p.PROVINCIA,
                comuna: p.COMUNA,
                area_c: p.AREA_C,
                manzent: p.MANZENT,
                distrito: p.DISTRITO,
                cod_distrito: p.COD_DISTRITO,
                cod_localidad: p.COD_LOCALIDAD,
                cod_zona: p.COD_ZONA,
                localidad: p.LOCALIDAD,
                cod_entidad: p.COD_ENTIDAD,
                cod_manzana: p.COD_MANZANA,
                entidad: p.ENTIDAD,
                tipo_mz: p.TIPO_MZ,
                cod_categoria: p.COD_CATEGORIA,
                categoria: p.CATEGORIA,
                mz_base_censo: p.MZ_BASE_CENSO,
                id_entidad: p.ID_ENTIDAD,
                id_localidad: p.ID_LOCALIDAD,
                id_distrito: p.ID_DISTRITO,
                id_zona: p.ID_ZONA,
                n_per: p.n_per || 0,
                n_hombres: p.n_hombres || 0,
                n_mujeres: p.n_mujeres || 0,
                n_edad_0_5: p.n_edad_0_5 || 0,
                n_edad_6_13: p.n_edad_6_13 || 0,
                n_edad_14_17: p.n_edad_14_17 || 0,
                n_edad_18_24: p.n_edad_18_24 || 0,
                n_edad_25_44: p.n_edad_25_44 || 0,
                n_edad_45_59: p.n_edad_45_59 || 0,
                n_edad_60_mas: p.n_edad_60_mas || 0,
                prom_edad: p.prom_edad,
                n_inmigrantes: p.n_inmigrantes || 0,
                n_nacionalidad: p.n_nacionalidad || 0,
                n_pueblos_orig: p.n_pueblos_orig,
                n_afrodescendencia: p.n_afrodescendencia || 0,
                n_lengua_indigena: p.n_lengua_indigena || 0,
                n_religion: p.n_religion || 0,
                n_dificultad_ver: p.n_dificultad_ver || 0,
                n_dificultad_oir: p.n_dificultad_oir || 0,
                n_dificultad_mover: p.n_dificultad_mover || 0,
                n_dificultad_cogni: p.n_dificultad_cogni || 0,
                n_dificultad_cuidado: p.n_dificultad_cuidado || 0,
                n_dificultad_comunic: p.n_dificultad_comunic || 0,
                n_discapacidad: p.n_discapacidad || 0,
                n_estcivcon_casado: p.n_estcivcon_casado || 0,
                n_estcivcon_conviviente: p.n_estcivcon_conviviente || 0,
                n_estcivcon_conv_civil: p.n_estcivcon_conv_civil || 0,
                n_estcivcon_anul_sep_div: p.n_estcivcon_anul_sep_div || 0,
                n_estcivcon_viudo: p.n_estcivcon_viudo || 0,
                n_estcivcon_soltero: p.n_estcivcon_soltero || 0,
                prom_escolaridad18: p.prom_escolaridad18,
                n_asistencia_parv: p.n_asistencia_parv || 0,
                n_asistencia_basica: p.n_asistencia_basica || 0,
                n_asistencia_media: p.n_asistencia_media || 0,
                n_asistencia_superior: p.n_asistencia_superior || 0,
                n_cine_nunca_curso_primera_infancia: p.n_cine_nunca_curso_primera_infancia || 0,
                n_cine_primaria: p.n_cine_primaria || 0,
                n_cine_secundaria: p.n_cine_secundaria || 0,
                n_cine_terciaria_maestria_doctorado: p.n_cine_terciaria_maestria_doctorado || 0,
                n_cine_especial_diferencial: p.n_cine_especial_diferencial || 0,
                n_analfabet: p.n_analfabet || 0,
                n_ocupado: p.n_ocupado || 0,
                n_desocupado: p.n_desocupado || 0,
                n_fuera_fuerza_trabajo: p.n_fuera_fuerza_trabajo || 0,
                n_cise_rec_independientes: p.n_cise_rec_independientes || 0,
                n_cise_rec_dependientes: p.n_cise_rec_dependientes || 0,
                n_cise_rec_trabajador_no_remunerado: p.n_cise_rec_trabajador_no_remunerado || 0,
                n_ciuo_0: p.n_ciuo_0 || 0,
                n_ciuo_1: p.n_ciuo_1 || 0,
                n_ciuo_2: p.n_ciuo_2 || 0,
                n_ciuo_3: p.n_ciuo_3 || 0,
                n_ciuo_4: p.n_ciuo_4 || 0,
                n_ciuo_5: p.n_ciuo_5 || 0,
                n_ciuo_6: p.n_ciuo_6 || 0,
                n_ciuo_7: p.n_ciuo_7 || 0,
                n_ciuo_8: p.n_ciuo_8 || 0,
                n_ciuo_9: p.n_ciuo_9 || 0,
                n_caenes_a: p.n_caenes_A || 0,
                n_caenes_b: p.n_caenes_B || 0,
                n_caenes_c: p.n_caenes_C || 0,
                n_caenes_d: p.n_caenes_D || 0,
                n_caenes_e: p.n_caenes_E || 0,
                n_caenes_f: p.n_caenes_F || 0,
                n_caenes_g: p.n_caenes_G || 0,
                n_caenes_h: p.n_caenes_H || 0,
                n_caenes_i: p.n_caenes_I || 0,
                n_caenes_j: p.n_caenes_J || 0,
                n_caenes_k: p.n_caenes_K || 0,
                n_caenes_l: p.n_caenes_L || 0,
                n_caenes_m: p.n_caenes_M || 0,
                n_caenes_n: p.n_caenes_N || 0,
                n_caenes_o: p.n_caenes_O || 0,
                n_caenes_p: p.n_caenes_P || 0,
                n_caenes_q: p.n_caenes_Q || 0,
                n_caenes_r: p.n_caenes_R || 0,
                n_caenes_s: p.n_caenes_S || 0,
                n_caenes_t: p.n_caenes_T || 0,
                n_caenes_u: p.n_caenes_U || 0,
                n_transporte_auto: p.n_transporte_auto || 0,
                n_transporte_publico: p.n_transporte_publico || 0,
                n_transporte_camina: p.n_transporte_camina || 0,
                n_transporte_bicicleta: p.n_transporte_bicicleta || 0,
                n_transporte_motocicleta: p.n_transporte_motocicleta || 0,
                n_transporte_cab_lan_bote: p.n_transporte_cab_lan_bote || 0,
                n_transporte_otros: p.n_transporte_otros || 0,
                n_hog: p.n_hog || 0,
                prom_per_hog: p.prom_per_hog,
                n_hog_unipersonales: p.n_hog_unipersonales || 0,
                n_hog_60: p.n_hog_60 || 0,
                n_hog_menores: p.n_hog_menores || 0,
                n_jefatura_mujer: p.n_jefatura_mujer || 0,
                n_tenencia_propia_pagada: p.n_tenencia_propia_pagada || 0,
                n_tenencia_propia_pagandose: p.n_tenencia_propia_pagandose || 0,
                n_tenencia_arrendada_contrato: p.n_tenencia_arrendada_contrato || 0,
                n_tenencia_arrendada_sin_contrato: p.n_tenencia_arrendada_sin_contrato || 0,
                n_tenencia_cedida_trabajo: p.n_tenencia_cedida_trabajo || 0,
                n_tenencia_cedida_familiar: p.n_tenencia_cedida_familiar || 0,
                n_tenencia_otro: p.n_tenencia_otro || 0,
                n_comb_cocina_gas: p.n_comb_cocina_gas || 0,
                n_comb_cocina_parafina: p.n_comb_cocina_parafina || 0,
                n_comb_cocina_lena: p.n_comb_cocina_lena || 0,
                n_comb_cocina_pellet: p.n_comb_cocina_pellet || 0,
                n_comb_cocina_carbon: p.n_comb_cocina_carbon || 0,
                n_comb_cocina_electricidad: p.n_comb_cocina_electricidad || 0,
                n_comb_cocina_solar: p.n_comb_cocina_solar || 0,
                n_comb_cocina_no_utiliza: p.n_comb_cocina_no_utiliza || 0,
                n_comb_calefaccion_gas: p.n_comb_calefaccion_gas || 0,
                n_comb_calefaccion_parafina: p.n_comb_calefaccion_parafina || 0,
                n_comb_calefaccion_lena: p.n_comb_calefaccion_lena || 0,
                n_comb_calefaccion_pellet: p.n_comb_calefaccion_pellet || 0,
                n_comb_calefaccion_carbon: p.n_comb_calefaccion_carbon || 0,
                n_comb_calefaccion_electricidad: p.n_comb_calefaccion_electricidad || 0,
                n_comb_calefaccion_otra: p.n_comb_calefaccion_otra || 0,
                n_comb_calefaccion_no_utiliza: p.n_comb_calefaccion_no_utiliza || 0,
                n_serv_tel_movil: p.n_serv_tel_movil || 0,
                n_serv_compu: p.n_serv_compu || 0,
                n_serv_tablet: p.n_serv_tablet || 0,
                n_serv_internet_fija: p.n_serv_internet_fija || 0,
                n_serv_internet_movil: p.n_serv_internet_movil || 0,
                n_serv_internet_satelital: p.n_serv_internet_satelital || 0,
                n_internet: p.n_internet || 0,
                n_vp: p.n_vp || 0,
                n_vp_ocupada: p.n_vp_ocupada || 0,
                n_vp_desocupada: p.n_vp_desocupada || 0,
                n_tipo_viv_casa: p.n_tipo_viv_casa || 0,
                n_tipo_viv_depto: p.n_tipo_viv_depto || 0,
                n_tipo_viv_indigena: p.n_tipo_viv_indigena || 0,
                n_tipo_viv_pieza: p.n_tipo_viv_pieza || 0,
                n_tipo_viv_mediagua: p.n_tipo_viv_mediagua || 0,
                n_tipo_viv_movil: p.n_tipo_viv_movil || 0,
                n_tipo_viv_otro: p.n_tipo_viv_otro || 0,
                n_dormitorios_1: p.n_dormitorios_1 || 0,
                n_dormitorios_2: p.n_dormitorios_2 || 0,
                n_dormitorios_3: p.n_dormitorios_3 || 0,
                n_dormitorios_4: p.n_dormitorios_4 || 0,
                n_dormitorios_5: p.n_dormitorios_5 || 0,
                n_dormitorios_6_o_mas: p.n_dormitorios_6_o_mas || 0,
                n_viv_hacinadas: p.n_viv_hacinadas || 0,
                n_viv_irrecuperables: p.n_viv_irrecuperables || 0,
                n_hog_allegados: p.n_hog_allegados || 0,
                n_nucleos_hacinados_allegados: p.n_nucleos_hacinados_allegados || 0,
                n_viv_no_ampliables: p.n_viv_no_ampliables || 0,
                n_deficit_cuantitativo: p.n_deficit_cuantitativo || 0,
                n_mat_paredes_hormigon: p.n_mat_paredes_hormigon || 0,
                n_mat_paredes_albanileria: p.n_mat_paredes_albanileria || 0,
                n_mat_paredes_tabique_forrado: p.n_mat_paredes_tabique_forrado || 0,
                n_mat_paredes_tabique_sin_forro: p.n_mat_paredes_tabique_sin_forro || 0,
                n_mat_paredes_artesanal: p.n_mat_paredes_artesanal || 0,
                n_mat_paredes_precarios: p.n_mat_paredes_precarios || 0,
                n_mat_techo_tejas: p.n_mat_techo_tejas || 0,
                n_mat_techo_hormigon: p.n_mat_techo_hormigon || 0,
                n_mat_techo_zinc: p.n_mat_techo_zinc || 0,
                n_mat_techo_fibrocemento: p.n_mat_techo_fibrocemento || 0,
                n_mat_techo_fonolita: p.n_mat_techo_fonolita || 0,
                n_mat_techo_paja: p.n_mat_techo_paja || 0,
                n_mat_techo_precarios: p.n_mat_techo_precarios || 0,
                n_mat_techo_sin_cubierta: p.n_mat_techo_sin_cubierta || 0,
                n_mat_piso_radier_con_revestimiento: p.n_mat_piso_radier_con_revestimiento || 0,
                n_mat_piso_radier_sin_revestimiento: p.n_mat_piso_radier_sin_revestimiento || 0,
                n_mat_piso_baldosa_cemento: p.n_mat_piso_baldosa_cemento || 0,
                n_mat_piso_capa_cemento: p.n_mat_piso_capa_cemento || 0,
                n_mat_piso_tierra: p.n_mat_piso_tierra || 0,
                n_fuente_agua_publica: p.n_fuente_agua_publica || 0,
                n_fuente_agua_pozo: p.n_fuente_agua_pozo || 0,
                n_fuente_agua_camion: p.n_fuente_agua_camion || 0,
                n_fuente_agua_rio: p.n_fuente_agua_rio || 0,
                n_distrib_agua_llave: p.n_distrib_agua_llave || 0,
                n_distrib_agua_llave_fuera: p.n_distrib_agua_llave_fuera || 0,
                n_distrib_agua_acarreo: p.n_distrib_agua_acarreo || 0,
                n_serv_hig_alc_dentro: p.n_serv_hig_alc_dentro || 0,
                n_serv_hig_alc_fuera: p.n_serv_hig_alc_fuera || 0,
                n_serv_hig_fosa: p.n_serv_hig_fosa || 0,
                n_serv_hig_pozo: p.n_serv_hig_pozo || 0,
                n_serv_hig_acequia_canal: p.n_serv_hig_acequia_canal || 0,
                n_serv_hig_cajon_otro: p.n_serv_hig_cajon_otro || 0,
                n_serv_hig_bano_quimico: p.n_serv_hig_bano_quimico || 0,
                n_serv_hig_bano_seco: p.n_serv_hig_bano_seco || 0,
                n_serv_hig_no_tiene: p.n_serv_hig_no_tiene || 0,
                n_fuente_elect_publica: p.n_fuente_elect_publica || 0,
                n_fuente_elect_diesel: p.n_fuente_elect_diesel || 0,
                n_fuente_elect_solar: p.n_fuente_elect_solar || 0,
                n_fuente_elect_eolica: p.n_fuente_elect_eolica || 0,
                n_fuente_elect_otro: p.n_fuente_elect_otro || 0,
                n_fuente_elect_no_tiene: p.n_fuente_elect_no_tiene || 0,
                n_basura_servicios: p.n_basura_servicios || 0,
                n_basura_entierra: p.n_basura_entierra || 0,
                n_basura_eriazo: p.n_basura_eriazo || 0,
                n_basura_rio: p.n_basura_rio || 0,
                n_basura_otro: p.n_basura_otro || 0,
                shape_length: p.SHAPE_Length,
                shape_area: p.SHAPE_Area,
                geom: JSON.stringify(f.geometry)
            };
        });

        const { error } = await supabase.from('manzanas').insert(batch);

        if (error) {
            console.error(`Error at batch ${i}:`, error);
            process.exit(1);
        }

        uploaded += batch.length;
        process.stdout.write(`\r   Uploaded ${uploaded}/${geojson.features.length}`);
    }

    console.log('\n\nðŸŽ‰ Done!');
}

upload();